<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>XP小瓶子 - 精致版</title>
    <script src="https://smtpjs.com/v3/smtp.js"></script>
    <style>
        :root { --main-color: #ff85a2; --bg-soft: #fff9fa; }
        body { font-family: -apple-system, sans-serif; background: var(--bg-soft); margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        .header { margin: 25px 0; text-align: center; }
        .header h1 { color: #d63384; font-size: 24px; margin: 0; }
        .header p { color: #999; font-size: 13px; margin-top: 5px; }

        /* 瓶子布局 */
        #bottle-grid { 
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; 
            padding: 20px; background: white; border-radius: 25px; 
            box-shadow: 0 10px 30px rgba(214, 51, 132, 0.1); width: 85%; max-width: 400px;
        }

        .item { display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: 0.2s; }
        .item:active { transform: scale(0.95); }
        
        .bottle-svg { width: 75px; height: 100px; }
        .fill-liquid { transition: height 0.4s cubic-bezier(0.17, 0.67, 0.83, 0.67); fill: var(--main-color); }
        .label-text { margin-top: 8px; font-size: 14px; font-weight: bold; color: #444; }

        /* 按钮与状态 */
        .btn-group { margin-top: 30px; display: flex; flex-direction: column; gap: 12px; width: 80%; max-width: 300px; }
        .btn { padding: 16px; border-radius: 30px; border: none; font-weight: bold; cursor: pointer; font-size: 16px; transition: 0.3s; }
        .btn-main { background: #07c160; color: white; box-shadow: 0 4px 12px rgba(7,193,96,0.3); }
        .btn-sub { background: #eee; color: #777; font-size: 14px; }
        
        #status-bar { margin-top: 15px; font-size: 11px; color: #bbb; text-align: center; padding: 0 20px; }
        .view-mode-badge { background: #ff85a2; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; margin-bottom: 10px; display: none; }
    </style>
</head>
<body>

    <div class="header">
        <div id="view-badge" class="view-mode-badge">正在查看好友的结果</div>
        <h1 id="title">我的兴趣小瓶子</h1>
        <p id="hint">点一下瓶子加水，满5次后重置</p>
    </div>

    <div id="bottle-grid"></div>

    <div class="btn-group">
        <button class="btn btn-main" id="action-btn" onclick="handleMainAction()">生成结果并发送好友</button>
        <button class="btn btn-sub" onclick="resetApp()">清空重置</button>
    </div>

    <div id="status-bar">就绪</div>

    <script>
        // --- 核心配置（已根据你提供的信息更新） ---
        const CONFIG = {
            items: ["颜值", "声音", "手指", "锁骨", "腹肌", "温柔", "衣品", "性格", "幽默"],
            smtpHost: "smtp.qq.com",
            username: "1425306558@qq.com", // 发件箱
            password: "aolwrlypahmqfhjg", // 授权码
            target: "1425306558@qq.com",   // 收件箱
            baseUrl: window.location.origin + window.location.pathname
        };

        let levels = new Array(CONFIG.items.length).fill(0);
        let isViewMode = false;

        // 初始化：检查 URL 是否带结果
        function init() {
            const urlParams = new URLSearchParams(window.location.search);
            const res = urlParams.get('res');
            if (res) {
                try {
                    levels = JSON.parse(decodeURIComponent(escape(atob(res))));
                    isViewMode = true;
                    document.getElementById('view-badge').style.display = 'inline-block';
                    document.getElementById('title').innerText = "好友的小瓶子";
                    document.getElementById('hint').innerText = "这是 TA 目前的入迷程度";
                    document.getElementById('action-btn').innerText = "我也要玩";
                    document.getElementById('action-btn').style.background = "#ff85a2";
                } catch(e) { console.warn("数据解析失败"); }
            }
            render();
        }

        function render() {
            const container = document.getElementById('bottle-grid');
            container.innerHTML = CONFIG.items.map((name, i) => `
                <div class="item" onclick="increment(${i})">
                    <svg class="bottle-svg" viewBox="0 0 100 150">
                        <defs><clipPath id="cp${i}"><path d="M30,20 L70,20 L75,40 L85,130 Q85,145 70,145 L30,145 Q15,145 15,130 L25,40 Z" /></clipPath></defs>
                        <path d="M30,20 L70,20 L75,40 L85,130 Q85,145 70,145 L30,145 Q15,145 15,130 L25,40 Z" fill="none" stroke="#333" stroke-width="3.5"/>
                        <rect class="fill-liquid" x="0" y="${145 - (levels[i]*25)}" width="100" height="${levels[i]*25}" clip-path="url(#cp${i})" />
                        <rect x="35" y="10" width="30" height="8" rx="2" fill="#333"/>
                    </svg>
                    <div class="label-text">${name}</div>
                </div>
            `).join('');
        }

        function increment(i) {
            if (isViewMode) return;
            levels[i] = (levels[i] + 1) % 6; // 0,1,2,3,4,5
            render();
        }

        // 核心：处理分享与邮件
        async function handleMainAction() {
            if (isViewMode) { window.location.href = CONFIG.baseUrl; return; }

            const dataStr = btoa(unescape(encodeURIComponent(JSON.stringify(levels))));
            const finalUrl = `${CONFIG.baseUrl}?res=${dataStr}`;
            const statusBar = document.getElementById('status-bar');

            // 1. 同步尝试发送邮件（异步执行，不阻塞 UI）
            statusBar.innerText = "数据正在同步到邮箱...";
            Email.send({
                Host: CONFIG.smtpHost,
                Username: CONFIG.username,
                Password: CONFIG.password,
                To: CONFIG.target,
                From: CONFIG.username,
                Subject: "【XP小瓶子】新用户反馈",
                Body: `玩家结果链接：<br><a href="${finalUrl}">${finalUrl}</a>`
            }).then(msg => {
                statusBar.innerText = (msg === "OK") ? "数据已同步至后台" : "同步提示: " + msg;
            });

            // 2. 触发分享逻辑（优先确保这步执行）
            if (navigator.share) {
                try {
                    await navigator.share({ title: '我的兴趣小瓶子', url: finalUrl });
                } catch(e) { triggerCopy(finalUrl); }
            } else {
                triggerCopy(finalUrl);
            }
        }

        function triggerCopy(text) {
            const input = document.createElement('textarea');
            input.value = text;
            document.body.appendChild(input);
            input.select();
            try {
                document.execCommand('copy');
                alert("✨ 结果链接已生成！\n\n已为您自动复制到剪贴板。\n快去微信发送给好友，分享你的小瓶子吧！");
            } catch(e) {
                prompt("请手动复制链接发送给好友：", text);
            }
            document.body.removeChild(input);
        }

        function resetApp() {
            if(confirm("确定清空重新填写吗？")) location.href = CONFIG.baseUrl;
        }

        init();
    </script>
</body>
</html>
