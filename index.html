<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>XP小瓶子 - 生成器</title>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script type="text/javascript">
        (function() {
            emailjs.init("k0Jq1yQ1_Y1PQF_lu"); // 你的 Public Key
        })();
    </script>
    <style>
        :root { --primary: #ff85a2; --bg: #fff5f7; }
        body { font-family: -apple-system, sans-serif; background-color: var(--bg); margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; overflow-x: hidden; }
        
        .header { margin: 20px 0; text-align: center; width: 90%; }
        .header h1 { color: #d63384; font-size: 24px; margin: 0; }
        .header p { color: #888; font-size: 13px; margin-top: 5px; }

        #bottle-grid { 
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; 
            padding: 15px; max-width: 400px; width: 85%; background: white; 
            border-radius: 20px; box-shadow: 0 10px 30px rgba(214,51,132,0.1); 
        }
        .bottle-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        .bottle-svg { width: 70px; height: 100px; }
        .bottle-fill { transition: height 0.4s ease; fill: var(--primary); }
        .bottle-label { margin-top: 8px; font-size: 13px; font-weight: bold; color: #444; border: none; text-align: center; width: 100%; background: transparent; pointer-events: none; }

        .actions { margin: 30px 0; display: flex; flex-direction: column; gap: 10px; width: 80%; max-width: 280px; }
        .btn { padding: 15px; border-radius: 30px; border: none; font-size: 16px; font-weight: bold; cursor: pointer; text-align: center; text-decoration: none; }
        .btn-share { background: #07c160; color: white; box-shadow: 0 4px 12px rgba(7,193,96,0.3); }
        .btn-reset { background: #eee; color: #777; font-size: 14px; }
        
        #status { font-size: 11px; color: #ccc; text-align: center; margin-top: 8px; }
        .view-banner { background: #ff85a2; color: white; padding: 5px 15px; border-radius: 20px; font-size: 12px; margin-bottom: 10px; display: none; }
    </style>
</head>
<body>

    <div class="header">
        <div id="view-tag" class="view-banner">正在查看好友分享的结果</div>
        <h1 id="title">我的兴趣小瓶子</h1>
        <p id="sub-title">点击瓶子加水（5次填满），分享给好友</p>
    </div>

    <div id="bottle-grid"></div>

    <div class="actions">
        <button class="btn btn-share" id="main-btn" onclick="handleShare()">生成结果并发送好友</button>
        <button class="btn btn-reset" onclick="location.href='index.html'">清空重集</button>
        <div id="status">准备就绪</div>
    </div>

    <script>
        const CFG = {
            items: ["眼睛", "声音", "手指", "锁骨", "腹肌", "温柔", "衣品", "性格", "幽默"],
            sID: "service_p5t1bos",
            tID: "template_ll4kgrl",
            base: "https://kaka2022.github.io/xptext/"
        };

        let state = new Array(CFG.items.length).fill(0);
        let isView = false;

        function init() {
            const p = new URLSearchParams(window.location.search).get('res');
            if (p) {
                try {
                    state = JSON.parse(decodeURIComponent(escape(atob(p))));
                    isView = true;
                    document.getElementById('view-tag').style.display = 'inline-block';
                    document.getElementById('title').innerText = "好友的小瓶子";
                    document.getElementById('main-btn').innerText = "我也要玩";
                    document.getElementById('main-btn').style.background = "#ff85a2";
                } catch(e) {}
            }
            render();
        }

        function render() {
            const grid = document.getElementById('bottle-grid');
            grid.innerHTML = CFG.items.map((item, i) => `
                <div class="bottle-item" onclick="tap(${i})">
                    <svg class="bottle-svg" viewBox="0 0 100 150">
                        <defs><clipPath id="cl${i}"><path d="M30,20 L70,20 L75,40 L85,130 Q85,145 70,145 L30,145 Q15,145 15,130 L25,40 Z" /></clipPath></defs>
                        <path d="M30,20 L70,20 L75,40 L85,130 Q85,145 70,145 L30,145 Q15,145 15,130 L25,40 Z" fill="none" stroke="#333" stroke-width="3"/>
                        <rect x="35" y="10" width="30" height="10" rx="2" fill="#333"/>
                        <rect class="bottle-fill" x="0" y="${145 - (state[i] * 25)}" width="100" height="${state[i] * 25}" clip-path="url(#cl${i})" />
                    </svg>
                    <div class="bottle-label">${item}</div>
                </div>
            `).join('');
        }

        function tap(i) {
            if (isView) return;
            state[i] = (state[i] + 1) % 6;
            render();
        }

        async function handleShare() {
            if (isView) { window.location.href = CFG.base; return; }

            const resStr = btoa(unescape(encodeURIComponent(JSON.stringify(state))));
            const url = `${CFG.base}?res=${resStr}`;
            const status = document.getElementById('status');

            // 1. 同步邮件后台
            status.innerText = "数据同步中...";
            emailjs.send(CFG.sID, CFG.tID, {
                share_url: url
            }).then(() => {
                status.innerText = "数据已实时备份";
            }).catch(e => {
                status.innerText = "网络稍慢，不影响分享";
            });

            // 2. 唤起分享
            if (navigator.share) {
                try {
                    await navigator.share({ title: '我的小瓶子', url: url });
                } catch (err) { copy(url); }
            } else {
                copy(url);
            }
        }

        function copy(t) {
            const el = document.createElement('textarea');
            el.value = t;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            alert('✅ 结果已生成！\n\n链接已复制，请直接粘贴发给微信好友。');
        }

        init();
    </script>
</body>
</html>
