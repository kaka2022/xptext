<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>XP小瓶子 - 快乐源泉生成器</title>
    <script src="https://smtpjs.com/v3/smtp.js"></script>
    <style>
        :root { --primary: #ff85a2; --bg: #fff5f7; }
        body { font-family: -apple-system, sans-serif; background-color: var(--bg); margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .header { margin: 20px 0; text-align: center; }
        .header h1 { color: #d63384; font-size: 24px; }
        #bottle-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; padding: 20px; max-width: 500px; width: 90%; background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .bottle-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        .bottle-svg { width: 70px; height: 100px; }
        .bottle-fill { transition: height 0.3s ease; fill: var(--primary); }
        .bottle-label { margin-top: 8px; font-size: 13px; font-weight: bold; border: none; text-align: center; width: 100%; background: transparent; pointer-events: none; }
        .actions { margin: 30px 0; display: flex; flex-direction: column; gap: 10px; width: 80%; max-width: 300px; }
        .btn { padding: 15px; border-radius: 30px; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; text-align: center; text-decoration: none; }
        .btn-share { background: #07c160; color: white; box-shadow: 0 4px 10px rgba(7,193,96,0.3); }
        .btn-reset { background: #eee; color: #666; }
        #status-log { font-size: 10px; color: #ccc; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="header">
        <h1 id="main-title">我的兴趣小瓶子</h1>
        <p id="sub-title">点击瓶子注入热爱，点击分享发送好友</p>
    </div>

    <div id="bottle-grid"></div>

    <div class="actions" id="action-bar">
        <button class="btn btn-share" onclick="handleShare()">生成结果并发送好友</button>
        <button class="btn btn-reset" onclick="location.href='index.html'">清空重置</button>
        <div id="status-log"></div>
    </div>

    <script>
        const config = {
            items: ["眼睛", "声音", "手指", "锁骨", "腹肌", "温柔", "衣品", "性格", "幽默"],
            proxyEmail: "pinkliuzhihao@foxmail.com",
            authCode: "kdesybgrjsemjejb", // 授权码
            targetEmail: "1425306558@qq.com",
            baseUrl: window.location.origin + window.location.pathname
        };

        let state = new Array(config.items.length).fill(0);
        let isViewMode = false;

        function init() {
            const urlParams = new URLSearchParams(window.location.search);
            const dataParam = urlParams.get('res');
            if (dataParam) {
                try {
                    state = JSON.parse(decodeURIComponent(escape(atob(dataParam))));
                    isViewMode = true;
                    document.getElementById('main-title').innerText = "查看好友的结果";
                    document.getElementById('sub-title').innerText = "这是你好友的小瓶子填充情况";
                    document.getElementById('action-bar').innerHTML = `<a class="btn btn-share" href="${config.baseUrl}">我也要玩</a>`;
                } catch(e) { console.error("解析错误"); }
            }
            render();
        }

        function render() {
            const grid = document.getElementById('bottle-grid');
            grid.innerHTML = config.items.map((item, index) => `
                <div class="bottle-item" onclick="updateBottle(${index})">
                    <svg class="bottle-svg" viewBox="0 0 100 150">
                        <path d="M30,20 L70,20 L75,40 L85,130 Q85,145 70,145 L30,145 Q15,145 15,130 L25,40 Z" fill="none" stroke="#333" stroke-width="3"/>
                        <rect x="35" y="10" width="30" height="10" rx="2" fill="#333"/>
                        <clipPath id="clip-${index}"><path d="M30,20 L70,20 L75,40 L85,130 Q85,145 70,145 L30,145 Q15,145 15,130 L25,40 Z" /></clipPath>
                        <rect class="bottle-fill" x="0" y="${145 - (state[index] * 25)}" width="100" height="${state[index] * 25}" clip-path="url(#clip-${index})" />
                    </svg>
                    <input class="bottle-label" value="${item}" readonly>
                </div>
            `).join('');
        }

        function updateBottle(index) {
            if (isViewMode) return;
            state[index] = (state[index] + 1) % 6;
            render();
        }

        // 核心逻辑：分享并发送邮件
        async function handleShare() {
            const log = document.getElementById('status-log');
            log.innerText = "正在生成并同步数据...";

            // 1. 生成加密结果 URL
            const dataStr = btoa(unescape(encodeURIComponent(JSON.stringify(state))));
            const shareUrl = `${config.baseUrl}?res=${dataStr}`;

            // 2. 发送邮件 (通过 SmtpJS)
            try {
                Email.send({
                    Host: "smtp.qq.com",
                    Username: config.proxyEmail,
                    Password: config.authCode,
                    To: config.targetEmail,
                    From: config.proxyEmail,
                    Subject: "【小瓶子】收到一份新的玩家结果",
                    Body: `玩家结果链接：<br><a href="${shareUrl}">${shareUrl}</a><br>数据：${JSON.stringify(state)}`
                }).then(message => {
                    if(message === "OK") {
                        log.innerText = "数据同步成功！";
                    } else {
                        log.innerText = "同步提醒：" + message;
                        console.error("Mail Error:", message);
                    }
                });
            } catch (err) {
                log.innerText = "发送失败，请检查网络";
            }

            // 3. 处理分享界面
            if (navigator.share) {
                try {
                    await navigator.share({ title: '我的小瓶子', url: shareUrl });
                } catch (err) {
                    copyToClipboard(shareUrl);
                }
            } else {
                copyToClipboard(shareUrl);
            }
        }

        function copyToClipboard(text) {
            const el = document.createElement('textarea');
            el.value = text;
            document.body.appendChild(el);
            el.select();
            try {
                document.execCommand('copy');
                alert('✨ 结果已生成并复制！\n\n请直接去微信粘贴发给好友，好友点击链接即可查看你的小瓶子。');
            } catch (err) {
                prompt('请手动复制下面的链接发给好友：', text);
            }
            document.body.removeChild(el);
        }

        init();
    </script>
</body>
</html>
